<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#4d1e90"><meta name="author" content="会飞的土豆"><meta name="copyright" content="会飞的土豆"><meta name="generator" content="Hexo 6.2.0"><meta name="theme" content="hexo-theme-yun"><title>基于 lerna 管理 monorepo 的一次实践记录 | 土豆子的躺平日常</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/star-markdown-css@0.3.3/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="https://fastly.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/png" href="/images/avatar.jpg"><link rel="mask-icon" href="/images/avatar.jpg" color="#4d1e90"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="preconnect" href="https://fastly.jsdelivr.net/npm/" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"flynna.github.io","root":"/","title":"相信土豆真的会飞","version":"1.10.4","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"搜索...","empty":"找不到您查询的内容: ${query}","hits":"找到 ${hits} 条结果","hits_time":"找到 ${hits} 条结果（用时 ${time} 毫秒）"},"anonymous_image":"https://cdn.yunyoujun.cn/img/avatar/none.jpg","say":{"api":"https://el-bot-api.vercel.app/api/words/young"},"local_search":{"path":"/search.xml"},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"fireworks":{"colors":null},"vendors":{"darken":"https://fastly.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="stylesheet" href="/font/iconfont.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js"></script><script src="/font/iconfont.js"></script><meta name="description" content="lerna是什么？ Lerna is a fast modern build system for managing and publishing multiple JavaScript&#x2F;TypeScript packages from the same repository.  lerna and nx的其他博客文章 为什么要用lerna?官方解释：  Lerna 在 repo 中链接">
<meta property="og:type" content="article">
<meta property="og:title" content="基于 lerna 管理 monorepo 的一次实践记录">
<meta property="og:url" content="https://flynna.github.io/engineering/lerna/index.html">
<meta property="og:site_name" content="土豆子的躺平日常">
<meta property="og:description" content="lerna是什么？ Lerna is a fast modern build system for managing and publishing multiple JavaScript&#x2F;TypeScript packages from the same repository.  lerna and nx的其他博客文章 为什么要用lerna?官方解释：  Lerna 在 repo 中链接">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://flynna.github.io/images/share/lerna/p1.png">
<meta property="article:published_time" content="2022-07-26T12:25:37.000Z">
<meta property="article:modified_time" content="2022-07-27T06:28:32.000Z">
<meta property="article:author" content="会飞的土豆">
<meta property="article:tag" content="lerna">
<meta property="article:tag" content="monorepo">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://flynna.github.io/images/share/lerna/p1.png"><script>(function() {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script></head><body><script src="https://code.iconify.design/2/2.1.1/iconify.min.js"></script><script>// Define global variable
IconifyProviders = {
  // Empty prefix: overwrite default API provider configuration
  '': {
    // Use custom API first, use Iconify public API as backup
    resources: [
        'https://api.iconify.design',
    ],
    // Wait for 1 second before switching API hosts
    rotate: 1000,
  },
};</script><script defer src="https://fastly.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="文章目录"><span class="icon iconify" data-icon="ri:list-ordered"></span></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="站点概览"><span class="icon iconify" data-icon="ri:passport-line"></span></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="会飞的土豆"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="会飞的土豆"><span class="site-author-status" title="Looking for dawn.">🍋</span></a><div class="site-author-name"><a href="/about/">会飞的土豆</a></div><span class="site-name">土豆子的躺平日常</span><sub class="site-subtitle">just do it</sub><div class="site-description">星光不问赶路人, 岁月不负有心人</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="首页"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:home-4-line"></span></span></a><div class="site-state-item"><a href="/archives/" title="归档"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:archive-line"></span></span><span class="site-state-item-count">52</span></a></div><div class="site-state-item"><a href="/categories/" title="分类"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:folder-2-line"></span></span><span class="site-state-item-count">37</span></a></div><div class="site-state-item"><a href="/tags/" title="标签"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="site-state-item-count">82</span></a></div><a class="site-state-item hty-icon-button" href="/about/#comment" title="留言板"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:clipboard-line"></span></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://wpa.qq.com/msgrd?v=3&amp;uin=2274105875&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/flynna" title="GitHub" target="_blank" style="color:#181717"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="flynnzhl@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://weibo.com/flynna" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://music.163.com/#/user/home?id=502374002" title="网易云音乐" target="_blank" style="color:#C10D0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.zhihu.com/people/flynn-zhl" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://space.bilibili.com/482340176" title="哔哩哔哩动画" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><span class="icon iconify" data-icon="ri:contrast-2-line"></span></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#lerna%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">lerna是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8lerna"><span class="toc-number">2.</span> <span class="toc-text">为什么要用lerna?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%AE%89%E8%A3%85lerna"><span class="toc-number">3.</span> <span class="toc-text">全局安装lerna</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#lerna%E4%BD%BF%E7%94%A8%E5%AE%9E%E8%B7%B5"><span class="toc-number">4.</span> <span class="toc-text">lerna使用实践</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96git%E4%BB%93%E5%BA%93"><span class="toc-number">4.1.</span> <span class="toc-text">初始化git仓库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lerna%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">4.2.</span> <span class="toc-text">lerna初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%8C%E5%96%84lerna-json%E9%85%8D%E7%BD%AE"><span class="toc-number">4.3.</span> <span class="toc-text">完善lerna.json配置</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#lerna-json%E7%9A%84%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E"><span class="toc-number">4.3.1.</span> <span class="toc-text">lerna.json的配置参数说明</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BApackage"><span class="toc-number">4.4.</span> <span class="toc-text">创建package</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-number">4.5.</span> <span class="toc-text">安装依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%85%B1%E7%94%A8%E7%9A%84dependencicesordevDependencices"><span class="toc-number">4.5.1.</span> <span class="toc-text">安装共用的dependencicesordevDependencices</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BB%99%E6%8C%87%E5%AE%9A%E7%9A%84-packageA-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96A%E6%A8%A1%E5%9D%97"><span class="toc-number">4.5.2.</span> <span class="toc-text">给指定的 packageA 安装依赖A模块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#workspace%E5%90%84package%E4%B9%8B%E9%97%B4%E7%9A%84%E4%BE%9D%E8%B5%96"><span class="toc-number">4.5.3.</span> <span class="toc-text">workspace各package之间的依赖</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lerna-bootstrap%E5%AE%89%E8%A3%85%E6%89%80%E6%9C%89%E5%8C%85%E7%9A%84%E4%BE%9D%E8%B5%96"><span class="toc-number">4.6.</span> <span class="toc-text">lerna bootstrap安装所有包的依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%98%E5%8A%BF"><span class="toc-number">4.6.1.</span> <span class="toc-text">优势</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%B8%E8%BD%BD%E4%BE%9D%E8%B5%96"><span class="toc-number">4.7.</span> <span class="toc-text">卸载依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B8%85%E7%90%86%E4%BE%9D%E8%B5%96%E5%8C%85"><span class="toc-number">4.8.</span> <span class="toc-text">清理依赖包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%97%E5%87%BA%E5%B7%A5%E4%BD%9C%E5%8C%BA%E6%89%80%E6%9C%89%E7%9A%84package"><span class="toc-number">4.9.</span> <span class="toc-text">列出工作区所有的package</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%97%E5%87%BA%E9%9C%80%E8%A6%81publish%E6%9B%B4%E6%96%B0%E7%9A%84%E5%8C%85"><span class="toc-number">4.10.</span> <span class="toc-text">列出需要publish更新的包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#lerna-run%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC"><span class="toc-number">4.11.</span> <span class="toc-text">lerna run执行脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E5%B8%83"><span class="toc-number">4.12.</span> <span class="toc-text">发布</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BB%BA%E8%AE%AE"><span class="toc-number">4.12.1.</span> <span class="toc-text">建议</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95"><span class="toc-number">5.</span> <span class="toc-text">问题记录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-scope%E7%9A%84%E8%AF%B4%E6%98%8E"><span class="toc-number">5.1.</span> <span class="toc-text">关于--scope的说明</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%85%E5%90%8D%E5%B8%A6%E6%9C%89scope%E7%9A%84%E5%8F%91%E5%B8%83"><span class="toc-number">5.2.</span> <span class="toc-text">包名带有scope的发布?</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-%E5%89%8D%E7%BC%80%E5%8C%85%E6%B7%BB%E5%8A%A0%E4%BA%86access%E4%BB%8D%E7%84%B6%E6%8A%9B%E5%87%BA%E4%BA%86403%E5%BC%82%E5%B8%B8"><span class="toc-number">5.2.1.</span> <span class="toc-text">为什么@前缀包添加了access仍然抛出了403异常?</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%94%9F%E6%88%90changeLog-md%E6%96%87%E4%BB%B6"><span class="toc-number">5.3.</span> <span class="toc-text">如何生成changeLog.md文件?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%B0%86%E9%A2%84%E5%85%88%E5%AD%98%E5%9C%A8%E7%9A%84%E7%8B%AC%E7%AB%8B%E5%8C%85%E6%94%B6%E9%9B%86%E5%88%B0lerna%E7%AE%A1%E7%90%86%E7%9A%84%E4%BB%93%E5%BA%93%E4%B8%AD"><span class="toc-number">5.4.</span> <span class="toc-text">如何将预先存在的独立包收集到lerna管理的仓库中?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E5%A4%B1%E8%B4%A5%E5%90%8E%E6%80%8E%E4%B9%88%E9%87%8D%E6%96%B0%E5%8F%91%E5%B8%83"><span class="toc-number">5.5.</span> <span class="toc-text">发布失败后怎么重新发布?</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#4d1e90;"><link itemprop="mainEntityOfPage" href="https://flynna.github.io/engineering/lerna/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="会飞的土豆"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="土豆子的躺平日常"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">基于 lerna 管理 monorepo 的一次实践记录</h1><div class="post-meta"><div class="post-time" style="display:block"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-line"></span></span> <time title="创建时间：2022-07-26 20:25:37" itemprop="dateCreated datePublished" datetime="2022-07-26T20:25:37+08:00">2022-07-26</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:calendar-2-line"></span></span> <time title="修改时间：2022-07-27 14:28:32" itemprop="dateModified" datetime="2022-07-27T14:28:32+08:00">2022-07-27</time></div><span class="post-count"><span class="post-symbolcount"><span class="post-meta-item-icon" title="本文字数"><span class="icon iconify" data-icon="ri:file-word-line"></span></span> <span title="本文字数">2.6k</span><span class="post-meta-divider">-</span><span class="post-meta-item-icon" title="阅读时长"><span class="icon iconify" data-icon="ri:timer-line"></span></span> <span title="阅读时长">10m</span></span></span><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><span class="icon iconify" data-icon="ri:folder-line"></span></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/" style="--text-color:#F4DF4F" itemprop="url" rel="index"><span itemprop="text">前端工程化</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96/%E6%A8%A1%E5%9D%97%E5%8C%96%E7%AE%A1%E7%90%86/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">模块化管理</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/lerna/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">lerna</span></a><a class="tag-item" href="/tags/monorepo/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><span class="icon iconify" data-icon="ri:price-tag-3-line"></span></span><span class="tag-name">monorepo</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h3 id="lerna是什么？"><a href="#lerna是什么？" class="headerlink" title="lerna是什么？"></a><code>lerna</code>是什么？</h3><blockquote>
<p>Lerna is a fast modern build system for managing and publishing multiple JavaScript&#x2F;TypeScript packages from the same repository.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.nrwl.io/nx/home"><code>lerna and nx</code>的其他博客文章</a></p>
<h3 id="为什么要用lerna"><a href="#为什么要用lerna" class="headerlink" title="为什么要用lerna?"></a>为什么要用<code>lerna</code>?</h3><p><code>官方解释：</code></p>
<blockquote>
<p>Lerna 在 repo 中链接不同的项目，因此它们可以相互导入，而无需向 NPM 发布任何内容</p>
</blockquote>
<blockquote>
<p>Lerna 对任意数量的项目运行命令，它以最有效的方式、以正确的顺序执行它，并且可以将其分布在多台机器上</p>
</blockquote>
<blockquote>
<p>Lerna 管理您的发布流程，从版本管理到发布再到 NPM，它提供了多种选项来确保可以适应任何工作流程</p>
</blockquote>
<p>结合工作中的实际体验，谈谈我的看法：</p>
<blockquote>
<p>公司一般都有自己的 npm 私库，有很多的 package 相互之间存在或多或少的关联。随着业务需求的不断升级，我在维护这些 package 的时候就碰到了一个很操蛋的问题：比如我改了 packageA 然后发布，那么所有用到了 packageA 的其他 package，也要跟着升级 packageA 的依赖，然后再发布，过程显得很是繁琐，此时如果你的 package 是通过 lerna 管理，就可以很好的避免这个问题。</p>
</blockquote>
<span id="more"></span>

<hr>
<h3 id="全局安装lerna"><a href="#全局安装lerna" class="headerlink" title="全局安装lerna"></a>全局安装<code>lerna</code></h3><p><code>tips: 注意 lerna@5.1.0 前后区别.</code></p>
<blockquote>
<p>npm i -g <a href="mailto:&#x6c;&#x65;&#114;&#110;&#97;&#64;&#x34;&#x2e;&#x30;&#46;&#48;">&#x6c;&#x65;&#114;&#110;&#97;&#64;&#x34;&#x2e;&#x30;&#46;&#48;</a></p>
</blockquote>
<h3 id="lerna使用实践"><a href="#lerna使用实践" class="headerlink" title="lerna使用实践"></a><code>lerna</code>使用实践</h3><h4 id="初始化git仓库"><a href="#初始化git仓库" class="headerlink" title="初始化git仓库"></a>初始化<code>git</code>仓库</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 初始化一个 utils 的 lerna 项目</span>
<span class="token function">mkdir</span> utils <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> utils
<span class="token function">git</span> init
<span class="token function">git</span> remote <span class="token function">add</span> origin <span class="token punctuation">[</span>xxx<span class="token punctuation">]</span></code></pre>

<p>配置<code>.gitignore</code></p>
<pre class="language-none"><code class="language-none">node_modules
lib
dist
logs
coverage
*&#x2F;.config&#x2F;*</code></pre>

<h4 id="lerna初始化"><a href="#lerna初始化" class="headerlink" title="lerna初始化"></a><code>lerna</code>初始化</h4><p><code>lerna</code>有两种发布模式，固定模式<code>fixed</code>（默认）、独立模式<code>independent</code>。两者的区别：</p>
<blockquote>
<p>固定模式：lerna init 通过 lerna.json 里的版本进行统一的版本管理。其中的任何一个包的改动都会导致所有的 packages 的版本号进行升级。</p>
</blockquote>
<blockquote>
<p>独立模式：lerna init --independent 允许使用者对每个包单独改变版本号。每次发布的时候，针对所有有更新的 package 询问需要升级的版本号。（基于自身的 package.json 版本号）这种情况下，lerna.json 的版本号不会变化， 默认为 independent</p>
</blockquote>
<p><del>建议使用独立模式…</del> 下面开始初始化过程（附效果图）：</p>
<blockquote>
<p>lerna init --independent</p>
</blockquote>
<p><a href="/images/share/lerna/p1.png"><img src="/images/share/lerna/p1.png" alt="lerna-p1" loading="lazy"></a></p>
<h4 id="完善lerna-json配置"><a href="#完善lerna-json配置" class="headerlink" title="完善lerna.json配置"></a>完善<code>lerna.json</code>配置</h4><p>指定命令使用的<code>client</code>，默认是<code>npm</code>，可以是<code>yarn</code>.修改<code>lerna.json</code>，添加：</p>
<blockquote>
<p>“npmClient”: “yarn”</p>
</blockquote>
<p>指定使用<code>yarn workspaces</code>模式，并在<code>lerna</code>中开启，同时在根目录下的<code>package.json</code>中添加<code>workspaces</code>：（开启后<code>lerna bootstrap</code>命令由<code>yarn install</code>代理，等价于在<code>workspace</code>的根目录下执行<code>yarn install</code>，只有顶层有一个<code>node_modules</code>），<strong>这么做是因为 yarn 本身提供了较 lerna 更好的依赖分析与 hoisting 的功能</strong>：</p>
<blockquote>
<p>“useWorkspaces”: true</p>
</blockquote>
<blockquote>
<p>“workspaces”: [“packages&#x2F;*“]</p>
</blockquote>
<p>指定忽略发布的不必要的更新（比如<code>readme.md</code>）：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token comment">// 方式一：在`lerna.json`中添加：</span>
<span class="token property">"ignoreChanges"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"**/*.md"</span><span class="token punctuation">,</span> <span class="token string">"**/*.test.ts"</span><span class="token punctuation">,</span> <span class="token string">"**/*.e2e.ts"</span><span class="token punctuation">,</span> <span class="token string">"**/fixtures/**"</span><span class="token punctuation">,</span> <span class="token string">"**/test/**"</span><span class="token punctuation">,</span> <span class="token string">"**/__test__/**"</span><span class="token punctuation">]</span>

<span class="token comment">// 方式二：在指定的命令下添加：</span>
<span class="token property">"command"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token property">"publish"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"ignoreChanges"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"ignored-file"</span><span class="token punctuation">,</span> <span class="token string">"*.md"</span><span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token property">"bootstrap"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"ignore"</span><span class="token operator">:</span> <span class="token string">"component-*"</span><span class="token punctuation">,</span>
    <span class="token property">"npmClientArgs"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"--no-package-lock"</span><span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h5 id="lerna-json的配置参数说明"><a href="#lerna-json的配置参数说明" class="headerlink" title="lerna.json的配置参数说明"></a><code>lerna.json</code>的配置参数说明</h5><pre class="language-json" data-language="json"><code class="language-json"><span class="token comment">// version：当前库的版本</span>
<span class="token comment">// npmClient：允许指定命令使用的client， 默认是 npm， 可以设置成 yarn</span>
<span class="token comment">// useWorkspaces：使用 yarn workspaces 模式</span>
<span class="token comment">// ignoreChanges：一个不包含在 lerna changed/publish 的 glob 数组。使用这个去阻止发布不必要的更新，比如修复 README.md</span>
<span class="token comment">// command.publish.ignoreChanges：可以指定那些目录或者文件的变更不会被 publish</span>
<span class="token comment">// command.publish.registry：设置自定义的 npm 代理（比如使用公司自己搭建的私服）</span>
<span class="token comment">// command.publish.conventionalCommits：lerna version 会自动决定 version bump 和生成 CHANGELOG 文件</span>
<span class="token comment">// command.publish.message：一个 publish 时的自定义 commit 信息</span>
<span class="token comment">// command.bootstrap.ignore：指定不受 bootstrap 命令影响的包</span>
<span class="token comment">// command.bootstrap.npmClientArgs：指定默认传给 lerna bootstrap 命令的参数</span>
<span class="token comment">// command.bootstrap.scope：指定那些包会受 lerna bootstrap 命令影响</span>
<span class="token comment">// packages：指定包所在的目录</span></code></pre>

<p><del><code>ok</code>，准备工作做完了 😃😃😃</del></p>
<hr>
<h4 id="创建package"><a href="#创建package" class="headerlink" title="创建package"></a>创建<code>package</code></h4><p>这个过程可以通过手动创建，也可以通过命令生成：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ./packages
<span class="token function">mkdir</span> package-a package-b package-c
<span class="token comment"># 分别进入这三个目录初始化成包 ...</span>
<span class="token builtin class-name">cd</span> package-a <span class="token operator">&amp;&amp;</span> <span class="token function">npm</span> init -y</code></pre>

<p><code>or</code>：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># name：包名，loc 位置 [可选，不指定时默认就是 workspaces[0] 所指位置]</span>
lerna create <span class="token operator">&lt;</span> name <span class="token operator">></span> <span class="token punctuation">[</span>loc<span class="token punctuation">]</span>
<span class="token comment"># 例如：</span>
lerna create package-a</code></pre>

<p>目录结构：</p>
<pre class="language-none"><code class="language-none">├── lerna.json
├── package.json
└── packages
    ├── packageA
    │   ├── index.js
    │   └── package.json</code></pre>

<h4 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h4><h5 id="安装共用的dependencicesordevDependencices"><a href="#安装共用的dependencicesordevDependencices" class="headerlink" title="安装共用的dependencicesordevDependencices"></a>安装共用的<code>dependencices</code>or<code>devDependencices</code></h5><p>设置<code>root</code>的依赖，通常为一些开发工具. <code>eg: typescript、eslint、babel...</code></p>
<pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token function">yarn</span> <span class="token function">add</span> -W -D typescript <span class="token punctuation">[</span>-W -D <span class="token operator">==</span> --ignore-workspace-root-check --dev<span class="token punctuation">]</span>
<span class="token comment"># 卸载</span>
<span class="token function">yarn</span> remove -W typescript</code></pre>

<p>添加所有的<code>package</code>依赖（不包含<code>root</code>，而是在各自的<code>package.json</code>）：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lerna <span class="token function">add</span> lodash -D</code></pre>

<h5 id="给指定的-packageA-安装依赖A模块"><a href="#给指定的-packageA-安装依赖A模块" class="headerlink" title="给指定的 packageA 安装依赖A模块"></a>给指定的 packageA 安装依赖<code>A</code>模块</h5><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 推荐</span>
lerna <span class="token function">add</span> A packages/packageA

<span class="token comment"># 或者指定 --scope</span>
lerna <span class="token function">add</span> A --scope<span class="token operator">=</span>packageA
lerna <span class="token function">add</span> A --scope<span class="token operator">=</span>packageA --dev

<span class="token comment"># 或（这种方式安装的 A 如果是当前工作区的开发模块，需要带上版本号）</span>
<span class="token function">yarn</span> workspace packageA <span class="token function">add</span> A

<span class="token comment"># 安装 A 到指定前缀为 prefix- 的包</span>
lerna <span class="token function">add</span> A packages/prefix-*

<span class="token comment"># 安装 A 到所有名为 packageA 包中</span>
lerna <span class="token function">add</span> A **/packageA</code></pre>

<h5 id="workspace各package之间的依赖"><a href="#workspace各package之间的依赖" class="headerlink" title="workspace各package之间的依赖"></a><code>workspace</code>各<code>package</code>之间的依赖</h5><p><code>packages</code>下的各个包之间，也可以相互依赖，例如<code>moduleA</code>依赖了<code>moduleB</code>，而<code>moduleB</code>又依赖了<code>moduleC</code>。使用的方式同上，相差不大（基于软链接<code>symlink</code>实现）：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lerna <span class="token function">add</span> moduleB packages/moduleA
lerna <span class="token function">add</span> moduleC --scope moduleB</code></pre>

<h4 id="lerna-bootstrap安装所有包的依赖"><a href="#lerna-bootstrap安装所有包的依赖" class="headerlink" title="lerna bootstrap安装所有包的依赖"></a><code>lerna bootstrap</code>安装所有包的依赖</h4><p>在<code>lerna</code>中，执行<strong>默认的<code>bootstrap</code>命令</strong>会在每个<code>package</code>下安装各自<code>package.json</code>中的依赖。</p>
<p>当你使用<code>yarn workspace，并在lerna中开启该功能时</code>，<code>lerna bootstrap</code>将由<code>yarn install</code>代理，等价体现为在<code>workspace</code>的根目录下执行<code>yarn install</code>.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lerna bootstrap
<span class="token comment"># 效果等价于</span>
lerna <span class="token function">link</span> + <span class="token function">yarn</span> <span class="token function">install</span></code></pre>

<h5 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h5><blockquote>
<p>工作区的模块包之间可以相互依赖，并在你发布升级对应包的时候，自动检测其他依赖该模块的包。</p>
</blockquote>
<blockquote>
<p>相比 yarn link，这种方式只影响你工作区的依赖树，而不会污染全局。</p>
</blockquote>
<blockquote>
<p>node_modules 统一安装，生成单一 lock 文件，方便 yarn 更好的管理并构建依赖。</p>
</blockquote>
<h4 id="卸载依赖"><a href="#卸载依赖" class="headerlink" title="卸载依赖"></a>卸载依赖</h4><blockquote>
<p>lerna exec – <command> [..args] # 在所有包中运行该命令</p>
</blockquote>
<p>可以依据这个命令来实现指定模块的包卸载，<code>eg</code>：</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lerna <span class="token builtin class-name">exec</span> --scope<span class="token operator">=</span>packageA  <span class="token function">yarn</span> remove A <span class="token comment"># 将 packageA 包下的 A 卸载</span>
lerna <span class="token builtin class-name">exec</span> -- <span class="token function">yarn</span> remove A <span class="token comment"># 将所有包下的 A 卸载</span></code></pre>

<h4 id="清理依赖包"><a href="#清理依赖包" class="headerlink" title="清理依赖包"></a>清理依赖包</h4><p>快速删除所有模块中的<code>node_modules</code>文件夹。</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lerna clean</code></pre>

<p><a target="_blank" rel="noopener" href="https://lerna.js.org/docs/features/bootstrap">更多的 <code>bootstrap</code>细节</a></p>
<h4 id="列出工作区所有的package"><a href="#列出工作区所有的package" class="headerlink" title="列出工作区所有的package"></a>列出工作区所有的<code>package</code></h4><p>如果与你文夹里面的不符，进入那个包运行<code>yarn init -y</code>解决.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lerna list
<span class="token comment"># or</span>
lerna <span class="token function">ls</span></code></pre>

<h4 id="列出需要publish更新的包"><a href="#列出需要publish更新的包" class="headerlink" title="列出需要publish更新的包"></a>列出需要<code>publish</code>更新的包</h4><pre class="language-bash" data-language="bash"><code class="language-bash">lerna changed</code></pre>

<blockquote>
<p>lerna 每次发布都会为对应的版本打 TAG，变动检测其实是依据 <code>git diff --name-only v版本</code>收集变动信息.</p>
</blockquote>
<blockquote>
<p><code>lerna diff</code>查看自上次发布以来的所有包或者指定包的 git diff 变化。</p>
</blockquote>
<h4 id="lerna-run执行脚本"><a href="#lerna-run执行脚本" class="headerlink" title="lerna run执行脚本"></a><code>lerna run</code>执行脚本</h4><p>通过<code>lerna run xx</code>执行脚本时，<code>lerna</code>会先检测符合条件（含有<code>xx</code>命令）的<code>package</code>，然后再各自内部执行<code>npm run xx</code>.</p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lerna run <span class="token builtin class-name">test</span>
<span class="token comment"># 区别于普通项目之处在于各个package之间存在相互依赖，如packageB只有在packageA构建完之后才能进行构建，否则就会出错，这实际上要求我们以一种拓扑排序的规则进行构建。</span>
lerna run --stream --sort build</code></pre>

<p>区别于<code>yarn workspaces run</code>：</p>
<blockquote>
<p>yarn workspaces run 执行 xx 指令时，必须所有的包都含有该 xx 命令，否则在执行过程中会抛出异常.</p>
</blockquote>
<h4 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h4><pre class="language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 执行该命令后，会根据检测出的有变动的 package 提示你选择对应要升级到的新版本号</span>
lerna publish
<span class="token comment"># 或者默认选项全部选择 Yes，并根据 commit 信息自动升级版本号</span>
lerna publish -y</code></pre>

<h5 id="建议"><a href="#建议" class="headerlink" title="建议"></a>建议</h5><blockquote>
<p>不要自己手动为<code>lerna</code>管理的仓库添加<code>tag</code>，防止 <code>package</code>变更检测异常，导致无法正常升级发布</p>
</blockquote>
<blockquote>
<p>尽量只在一个分支上发布，避免多个分支同时进行且生成相同版本</p>
</blockquote>
<blockquote>
<p>每次<code>publish</code>之前，先<code>commit</code>代码，保证工作区是干净的</p>
</blockquote>
<blockquote>
<p>确保你的<code>npm</code>账号是登录状态，否则会发布失败。<code>npm whoami</code>查看状态，可以指定<code>registry</code></p>
</blockquote>
<blockquote>
<p>确保你的<code>package</code>设置了正确的<code>npm registry</code>地址，且发布的包与已存在的包之间不会存在冲突</p>
</blockquote>
<blockquote>
<p>按顺序执行<code>lerna bootstrap -&gt; lerna run --stream --sort build（我在单个 package 中定义了一些 npm scripts，例如 prepublishOnly 钩子来执行 build，然而 npm-client 使用 yarn 后，这些钩子似乎并没有按预期进行工作，导致最终 publish 失败。通过 lerna run build 可以触发所有 package 执行 build，如果无此需求可以跳过该步骤）-&gt; lerna publish.</code></p>
</blockquote>
<h3 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h3><h4 id="关于-scope的说明"><a href="#关于-scope的说明" class="headerlink" title="关于--scope的说明"></a>关于<code>--scope</code>的说明</h4><blockquote>
<p>不管是安装还是卸载，<code>--scope=packageA</code>中的<code>packageA</code>均是指的具体包名，而非<code>path</code>，而另外一种方式<code>packages/packageA</code>则是指具体路径.</p>
</blockquote>
<h4 id="包名带有scope的发布"><a href="#包名带有scope的发布" class="headerlink" title="包名带有scope的发布?"></a>包名带有<code>scope</code>的发布?</h4><p>形如<code>@xxx/xx</code>，在你的子包（具体要发布的那个包）的<code>package.json</code>中添加<code>publishConfig.access</code>字段：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token property">"publishConfig"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token property">"access"</span><span class="token operator">:</span> <span class="token string">"public"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h5 id="为什么-前缀包添加了access仍然抛出了403异常"><a href="#为什么-前缀包添加了access仍然抛出了403异常" class="headerlink" title="为什么@前缀包添加了access仍然抛出了403异常?"></a>为什么<code>@</code>前缀包添加了<code>access</code>仍然抛出了<code>403</code>异常?</h5><p><code>@</code>符号后面的是你注册<code>npm</code>账户时的<code>username</code>，请确保该<code>scope</code>与你账户一致. <del>（前往官网注册你的账户，可以看到更加明确的错误提示）😂😂😂</del></p>
<h4 id="如何生成changeLog-md文件"><a href="#如何生成changeLog-md文件" class="headerlink" title="如何生成changeLog.md文件?"></a>如何生成<code>changeLog.md</code>文件?</h4><p><code>lerna.json</code>中添加：</p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token property">"command"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    <span class="token property">"publish"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// ...</span>
      <span class="token property">"allowBranch"</span><span class="token operator">:</span> <span class="token string">"master"</span><span class="token punctuation">,</span> <span class="token comment">// 只在 master 分支执行 publish</span>
      <span class="token property">"conventionalCommits"</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 生成 changelog 文件</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="如何将预先存在的独立包收集到lerna管理的仓库中"><a href="#如何将预先存在的独立包收集到lerna管理的仓库中" class="headerlink" title="如何将预先存在的独立包收集到lerna管理的仓库中?"></a>如何将预先存在的独立包收集到<code>lerna</code>管理的仓库中?</h4><p>将带有提交历史记录的包导入 <code>packages/&lt;directory-name&gt;</code>. 保留原始提交作者、日期和消息。另外：如果您要在新的 lerna 存储库上导入外部存储库，请记住至少有一次提交。<a target="_blank" rel="noopener" href="https://github.com/lerna/lerna/tree/main/commands/import#readme">-&gt; 戳这里</a></p>
<pre class="language-bash" data-language="bash"><code class="language-bash">lerna <span class="token function">import</span> <span class="token operator">&lt;</span>path-to-external-repository<span class="token operator">></span></code></pre>

<h4 id="发布失败后怎么重新发布"><a href="#发布失败后怎么重新发布" class="headerlink" title="发布失败后怎么重新发布?"></a>发布失败后怎么重新发布?</h4><p>运行<code>lerna publish</code>如果中途有包发布失败，再运行<code>lerna publish</code>的时候，因为<code>Tag</code>已经打上去了，所以不会再重新发布包到<code>NPM</code>.</p>
<p>先清空当前工作区的文件修改（主要是上一次发布时，每个<code>package</code>自身的<code>package.json</code>会修改<code>gitHead</code>，发布成功会被重置，失败后无法正常重置，需要手动放弃修改），然后：</p>
<blockquote>
<p>运行 <code>lerna publish from-git</code>，会把当前标签中涉及的<code>NPM</code>包再发布一次，PS：不会再更新<code>package.json</code>，只是执行<code>npm publish</code></p>
</blockquote>
<p><code>or</code>：</p>
<blockquote>
<p>运行 <code>lerna publish from-package</code>，会把当前所有本地包中的<code>package.json</code>和远端<code>NPM</code>比对，如果是 NPM 上不存在的包版本，都执行一次<code>npm publish</code></p>
</blockquote>
</div></section><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>会飞的土豆</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="https://flynna.github.io/engineering/lerna/" title="基于 lerna 管理 monorepo 的一次实践记录">https://flynna.github.io/engineering/lerna/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均默认采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><span class="icon iconify" data-icon="ri:creative-commons-line"></span><span class="icon iconify" data-icon="ri:creative-commons-by-line"></span><span class="icon iconify" data-icon="ri:creative-commons-nc-line"></span><span class="icon iconify" data-icon="ri:creative-commons-sa-line"></span></a> 许可协议。</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/bugs/git-errors/" rel="prev" title="git 使用过程中的踩坑记录"><span class="icon iconify" data-icon="ri:arrow-left-s-line"></span><span class="post-nav-text">git 使用过程中的踩坑记录</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/posts/github-create-pr/" rel="next" title="github 上如何为开源项目提交 pr?"><span class="post-nav-text">github 上如何为开源项目提交 pr?</span><span class="icon iconify" data-icon="ri:arrow-right-s-line"></span></a></div></div></div><div class="hty-card" id="comment"><div class="comment-tooltip text-center"><span>如果您有任何关于博客内容的相关讨论，欢迎前往 <a href="https://github.com/flynna/flynna.github.io/discussions" target="_blank">GitHub Discussions</a> 与我交流。</span><br></div><style>.utterances {
  max-width: 100%;
}</style><script src="https://giscus.app/client.js" data-repo="flynna/flynna.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkzNDE0MDgyNjE=" data-category="Announcements" data-category-id="DIC_kwDOFFl6Bc4CQHuO" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-theme="light" crossorigin="anonymous" async></script></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2022 – 2023 </span><span class="with-love" id="animate"><span class="icon iconify" data-icon="ri:cloud-line"></span></span><span class="author"> 会飞的土豆</span></div><div class="live-time"><span>本博客已萌萌哒地运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  setTimeout(blog_live_time, 1000);
  const start = new Date('2022-07-07T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = ` ${passDay} 天 ${passHour} 小时 ${passMinute} 分 ${passSecond} 秒`;
}
blog_live_time();
</script></div></footer></div><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><span class="icon iconify" data-icon="ri:arrow-up-s-line"></span><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#4d1e90" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="搜索"><span class="site-state-item-icon"><span class="icon iconify" data-icon="ri:search-line"></span></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="https://fastly.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script><script src="/js/search/local-search.js" defer type="module"></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><span class="icon iconify" data-icon="ri:close-line"></span></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="搜索..." value=""></div><div class="search-result-container"></div></div><script>function initMourn() {
  const date = new Date();
  const today = (date.getMonth() + 1) + "-" + date.getDate()
  const mourn_days = ["4-4","9-18"]
  if (mourn_days.includes(today)) {
    document.documentElement.style.filter = "grayscale(1)";
  }
}
initMourn();</script><script src="https://cdn.jsdelivr.net/npm/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-koharu@1.0.5/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body></html>